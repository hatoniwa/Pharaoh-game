<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>百の灯火 - 完全版</title>
    <style>
        body {
            margin: 0;
            background: black;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            color: white;
            font-family: sans-serif;
        }

        #game-container {
            position: relative;
            width: 640px;
            height: 360px;
            background-size: cover;
            background-position: center;
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            transition: background-image 1.5s ease-in-out; /* 背景画像の切り替えを滑らかに */
        }     
<script>
  // 追加：プリロード（存在する画像名を列挙）
  const preloadList = [
    'intro_cover_49.jpg','background_after_intro.jpg','second_background.jpg',
    'scene1.jpg','scene2.jpg','scene3.jpg','scene4.jpg','scene5.jpg',
    'egypt0.jpg','egypt1.jpg','egypt2.jpg','egypt3.jpg','egypt4.jpg','egypt5.jpg','egypt6.jpg','egypt7.jpg','egypt8.jpg'
  ];
  function preloadImages(list){
    return Promise.all(list.map(src => new Promise(res=>{
      const img = new Image();
      img.onload = img.onerror = () => res(true);
      img.src = src;
    })));
  }

  // 変更：自動開始ではなく Start ボタンで開始
  const startBtn = document.getElementById('startBtn');
  startBtn.addEventListener('click', async ()=>{
    startBtn.disabled = true; startBtn.textContent = 'Loading...';
    await preloadImages(preloadList);      // 先に読み込む
    startBtn.style.display = 'none';       // ボタンを消す
    setTimeout(startIntroAnimation, 300);  // あなたの既存関数を呼ぶ
  });

  // 既存の window.onload での自動開始は削除 or 無効化
  // window.onload = () => setTimeout(startIntroAnimation, 1000);
</script>

        #intro-cover {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 10;
        }

        #first-background, #second-background {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 1.5s ease-in-out;
        }

        #first-background { z-index: 5; }
        #second-background { z-index: 6; }
        
        #animation-pieces-container {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        .animated-cover-piece {
            position: absolute;
            /* background-imageはJavaScriptで設定するため削除 */
            background-size: 640px 360px;
            opacity: 1;
            transition: transform 1.5s ease-out, opacity 1.5s ease-out;
        }

        #narration-text {
            bottom: 65px;
            position: absolute;
            z-index: 15;
            color: white;
            font-size: 22px;
            font-weight: bold;
            text-align: center;
            background-color: black;
            padding: 12px 20px;
            border-radius: 8px;
            opacity: 0;
            transition: opacity 2s ease-in;
        }

        #subtitle {
            position: absolute;
            bottom: 20px;
            width: 90%;
            background-color: rgba(0, 0, 0, 0.6);
            padding: 12px;
            border-radius: 8px;
            font-size: 18px;
            opacity: 0;
            transition: opacity 1s;
            z-index: 15;
        }

        #countdown-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* 中央揃えを修正 */
            font-size: 32px;
            font-weight: bold;
            z-index: 20;
            display: none;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <img id="second-background" src="second_background.jpg" alt="次の背景">
        <img id="first-background" src="background_after_intro.jpg" alt="最初の裏背景">
        <img id="intro-cover" src="intro_cover_49.jpg" alt="カバー画像">
        
        <div id="animation-pieces-container"></div>
        <div id="narration-text">This poem hides a secret story.</div>
        <div id="subtitle"></div>
        <div id="countdown-screen"></div> </div>

    <script>
        // === DOM要素の取得 ===
        const gameContainer = document.getElementById('game-container');
        const introCover = document.getElementById('intro-cover');
        const firstBackground = document.getElementById('first-background');
        const secondBackground = document.getElementById('second-background');
        const animationPiecesContainer = document.getElementById('animation-pieces-container');
        const narrationText = document.getElementById('narration-text');
        const subtitle = document.getElementById('subtitle');
        const countdownScreen = document.getElementById('countdown-screen');

        // === 字幕データ ===
        const subtitlesKomachi_en = [
            { image: "scene1.jpg", text: "If you light the lamps for a hundred nights, then… I shall accept your feelings." },
            { image: "scene2.jpg", text: "Fujihara no Sanetaka climbed the freezing hill even in stormy nights—carrying the promise with Komachi in his heart." },
            { image: "scene3.jpg", text: "On the 99th night, he lit the lamp even while bedridden. That light was the flame of his very life." },
            { image: "scene4.jpg", text: "On the 100th morning, his lifeless body lay beneath the final lantern… the last light left unlit." },
            { image: "scene5.jpg", text: "The true darkness was not in the night, but in the heart that couldn’t believe in love. Now… let me light the final lamp." }
        ];

        const subtitlesEgypt_en = [
            { image: "egypt0.jpg", text: "There is a similar story told in ancient Egypt." },
            { image: "egypt1.jpg", text: "Nefertis: A priestess of divine beauty who served the temple. Though loyal to the king, she longed for freedom deep in her heart." },
            { image: "egypt2.jpg", text: "Aknam: A young soldier. His heart was devoted solely to Nefertis." },
            { image: "egypt3.jpg", text: "\"If you light the lamps for a hundred nights—then I shall accept your feelings.\"" },
            { image: "egypt4.jpg", text: "Through storms, Aknam climbed the freezing hill each night, carrying the promise with Nefertis in his heart." },
            { image: "egypt5.jpg", text: "On the 99th night, he fell into the river on his return. That light was his very life’s flame." },
            { image: "egypt6.jpg", text: "On the 100th morning, Nefertis found his cold body by the riverside. \"Why... why did you have to die?\"" },
            { image: "egypt7.jpg", text: "She wept. The final lamp remained unlit, alone in the dawn." },
            { image: "egypt8.jpg", text: "When will this long rain and my tears ever stop?" }
        ];

        // === 状態管理 ===
        let currentSubtitleIndex = 0;
        let currentMode = "komachi_en";

        // === ユーティリティ関数 ===
        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // === メインロジック ===

        /**
         * イントロアニメーションを開始
         */
        async function startIntroAnimation() {
            // 1. カバー画像を非表示にし、ピースを生成
            introCover.style.display = 'none';
            const coverImageUrl = introCover.src;
            const pieceCountX = 7;
            const pieceCountY = 7;
            const containerWidth = gameContainer.offsetWidth;
            const containerHeight = gameContainer.offsetHeight;
            const pieceWidth = containerWidth / pieceCountX;
            const pieceHeight = containerHeight / pieceCountY;

            for (let y = 0; y < pieceCountY; y++) {
                for (let x = 0; x < pieceCountX; x++) {
                    const pieceDiv = document.createElement('div');
                    pieceDiv.classList.add('animated-cover-piece');
                    pieceDiv.style.width = `${pieceWidth}px`;
                    pieceDiv.style.height = `${pieceHeight}px`;
                    pieceDiv.style.left = `${x * pieceWidth}px`;
                    pieceDiv.style.top = `${y * pieceHeight}px`;
                    pieceDiv.style.backgroundImage = `url('${coverImageUrl}')`;
                    pieceDiv.style.backgroundPosition = `-${x * pieceWidth}px -${y * pieceHeight}px`;
                    pieceDiv.style.transitionDelay = `${Math.random() * 0.6}s`;
                    animationPiecesContainer.appendChild(pieceDiv);

                    // 少し遅れてアニメーションを開始
                    setTimeout(() => {
                        const randomX = (Math.random() - 0.5) * containerWidth * 1.5;
                        const randomY = (Math.random() - 0.5) * containerHeight * 1.5;
                        const randomRotate = Math.random() * 640 - 360;
                        pieceDiv.style.transform = `translate(${randomX}px, ${randomY}px) rotate(${randomRotate}deg)`;
                        pieceDiv.style.opacity = 0;
                    }, 50);
                }
            }
            
            // 2. アニメーションとテキスト表示を順次実行
            await wait(1900);
            animationPiecesContainer.innerHTML = '';
            firstBackground.style.opacity = 1;

            await wait(1500);
            secondBackground.style.opacity = 1;

            await wait(1500);
            narrationText.style.opacity = 1;

            await wait(3000);
            narrationText.style.opacity = 0; // フェードアウトさせる
            
            await wait(1000);
            narrationText.style.display = 'none';
            showNextSubtitle();
        }
        
        /**
         * 物語の終わりを処理
         */
        function endStory() {
            subtitle.style.opacity = 0;
            countdownScreen.textContent = 'Fin';
            countdownScreen.style.display = 'block';
        }

        /**
         * 次の字幕と背景を表示
         */
        function showNextSubtitle() {
            let data = (currentMode === "komachi_en") ? subtitlesKomachi_en : subtitlesEgypt_en;

            // 現在のモードの物語が終了したかチェック
            if (currentSubtitleIndex >= data.length) {
                if (currentMode === "komachi_en") {
                    // 小町編が終了したらエジプト編へ
                    currentMode = "egypt_en";
                    currentSubtitleIndex = 0;
                    setTimeout(showNextSubtitle, 1000);
                } else {
                    // エジプト編が終了したら物語全体を終了
                    endStory();
                }
                return;
            }

            // 1. 次のデータを取得して表示
            const item = data[currentSubtitleIndex];
            gameContainer.style.backgroundImage = `url('${item.image}')`;
            subtitle.textContent = item.text;
            subtitle.style.opacity = 1;
            
            // イントロ用の背景を非表示にする
            firstBackground.style.display = 'none';
            secondBackground.style.display = 'none';

            // 2. 4秒後に字幕を非表示にし、次の字幕へ
            setTimeout(() => {
                subtitle.style.opacity = 0;
                currentSubtitleIndex++;
                setTimeout(showNextSubtitle, 1000); // 1秒後に次の字幕処理を呼び出す
            }, 4000);
        }

        // === 実行開始 ===
        window.onload = () => {
            // ページ読み込み1秒後にイントロを開始
            setTimeout(startIntroAnimation, 1000);
        };
    </script>
</body>
</html>
