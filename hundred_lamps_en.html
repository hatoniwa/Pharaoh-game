<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>百の灯火 - 完全版</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{
      margin:0; background:black; color:white; font-family:sans-serif;
      display:flex; justify-content:center; align-items:center; height:100vh; overflow:hidden;
    }
    #game-container{
      position:relative; width:640px; height:360px;
      background-size:cover; background-position:center;
      box-shadow:0 0 25px rgba(0,255,255,.8);
      display:flex; justify-content:center; align-items:center; text-align:center;
      transition: background-image 1.5s ease-in-out;
    }
    #intro-cover{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; z-index:10; }
    #first-background,#second-background{
      position:absolute; inset:0; width:100%; height:100%; object-fit:cover; opacity:0; transition:opacity 1.5s ease-in-out;
    }
    #first-background{ z-index:5; }
    #second-background{ z-index:6; }
    #animation-pieces-container{ position:absolute; inset:0; pointer-events:none; }
    .animated-cover-piece{
      position:absolute; background-size:640px 360px; opacity:1;
      transition: transform 1.5s ease-out, opacity 1.5s ease-out;
    }
    #narration-text{
      position:absolute; bottom:65px; z-index:15; background:black;
      padding:12px 20px; border-radius:8px; font-size:22px; font-weight:bold; opacity:0; transition:opacity 2s ease-in;
    }
    #subtitle{
      position:absolute; bottom:20px; left:5%; right:5%; z-index:15;
      background:rgba(0,0,0,.6); padding:12px; border-radius:8px; font-size:18px; opacity:0; transition:opacity 1s;
    }
    #countdown-screen{
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      font-size:32px; font-weight:bold; z-index:20; display:none;
    }
  </style>
</head>
<body>
  <div id="game-container">
    <!-- 背景/カバー -->
    <img id="second-background" src="second_background.jpg" alt="next background">
    <img id="first-background"  src="background_after_intro.jpg" alt="first background">
    <img id="intro-cover"      src="intro_cover_49.jpg" alt="cover">

    <!-- ピース演出 / テキスト -->
    <div id="animation-pieces-container"></div>
    <div id="narration-text">This poem hides a secret story.</div>
    <div id="subtitle"></div>
    <div id="countdown-screen"></div>

    <!-- ✅ Startボタン（左下・薄グレー地＋明るい緑文字） -->
    <button id="startBtn" style="
      position:absolute; bottom:20px; left:20px;
      width:140px; height:40px;
      background:#ccc; color:#3fa34d; border:1px solid #999; border-radius:8px;
      font-size:16px; font-weight:bold; cursor:pointer; z-index:50;">Tap Here</button>
  </div>

  <script>
    // ===== DOM =====
    const gameContainer = document.getElementById('game-container');
    const introCover = document.getElementById('intro-cover');
    const firstBackground = document.getElementById('first-background');
    const secondBackground = document.getElementById('second-background');
    const animationPiecesContainer = document.getElementById('animation-pieces-container');
    const narrationText = document.getElementById('narration-text');
    const subtitle = document.getElementById('subtitle');
    const countdownScreen = document.getElementById('countdown-screen');
    const startBtn = document.getElementById('startBtn');

    // ===== 字幕データ =====
    const subtitlesKomachi_en = [
      { image: "scene1.jpg", text: "If you light the lamps for a hundred nights, then… I shall accept your feelings." },
      { image: "scene2.jpg", text: "Fujihara no Sanetaka climbed the freezing hill even in stormy nights—carrying the promise with Komachi in his heart." },
      { image: "scene3.jpg", text: "On the 99th night, he lit the lamp even while bedridden. That light was the flame of his very life." },
      { image: "scene4.jpg", text: "On the 100th morning, his lifeless body lay beneath the final lantern… the last light left unlit." },
      { image: "scene5.jpg", text: "The true darkness was not in the night, but in the heart that couldn’t believe in love. Now… let me light the final lamp." }
    ];
    const subtitlesEgypt_en = [
      { image: "egypt0.jpg", text: "There is a similar story told in ancient Egypt." },
      { image: "egypt1.jpg", text: "Nefertis: A priestess of divine beauty who served the temple. Though loyal to the king, she longed for freedom deep in her heart." },
      { image: "egypt2.jpg", text: "Aknam: A young soldier. His heart was devoted solely to Nefertis." },
      { image: "egypt3.jpg", text: "\"If you light the lamps for a hundred nights—then I shall accept your feelings.\"" },
      { image: "egypt4.jpg", text: "Through storms, Aknam climbed the freezing hill each night, carrying the promise with Nefertis in his heart." },
      { image: "egypt5.jpg", text: "On the 99th night, he fell into the river on his return. That light was his very life’s flame." },
      { image: "egypt6.jpg", text: "On the 100th morning, Nefertis found his cold body by the riverside. \"Why... why did you have to die?\"" },
      { image: "egypt7.jpg", text: "She wept. The final lamp remained unlit, alone in the dawn." },
      { image: "egypt8.jpg", text: "When will this long rain and my tears ever stop?" }
    ];

    // ===== 便利 =====
    const wait = (ms) => new Promise(r => setTimeout(r, ms));

    // 画像プリロード
    const preloadList = [
      'intro_cover_49.jpg','background_after_intro.jpg','second_background.jpg',
      'scene1.jpg','scene2.jpg','scene3.jpg','scene4.jpg','scene5.jpg',
      'egypt0.jpg','egypt1.jpg','egypt2.jpg','egypt3.jpg','egypt4.jpg','egypt5.jpg','egypt6.jpg','egypt7.jpg','egypt8.jpg'
    ];
    function preloadImages(list){
      return Promise.all(list.map(src => new Promise(res=>{
        const img = new Image();
        img.onload = img.onerror = () => res(true);
        img.src = src;
      })));
    }

    // ===== イントロ開始 =====
    async function startIntroAnimation(){
      // カバーを49ピースに分解
      introCover.style.display = 'none';
      const coverImageUrl = introCover.src;
      const pieceCountX = 7, pieceCountY = 7;
      const containerWidth = gameContainer.offsetWidth;
      const containerHeight = gameContainer.offsetHeight;
      const pieceWidth = containerWidth / pieceCountX;
      const pieceHeight = containerHeight / pieceCountY;

      for(let y=0;y<pieceCountY;y++){
        for(let x=0;x<pieceCountX;x++){
          const d = document.createElement('div');
          d.className = 'animated-cover-piece';
          d.style.width = `${pieceWidth}px`;
          d.style.height = `${pieceHeight}px`;
          d.style.left = `${x * pieceWidth}px`;
          d.style.top  = `${y * pieceHeight}px`;
          d.style.backgroundImage = `url('${coverImageUrl}')`;
          d.style.backgroundPosition = `-${x * pieceWidth}px -${y * pieceHeight}px`;
          d.style.transitionDelay = `${Math.random() * 0.6}s`;
          animationPiecesContainer.appendChild(d);
          setTimeout(()=>{
            const rx = (Math.random()-0.5) * containerWidth  * 1.5;
            const ry = (Math.random()-0.5) * containerHeight * 1.5;
            const rr = (Math.random()*640 - 360);
            d.style.transform = `translate(${rx}px, ${ry}px) rotate(${rr}deg)`;
            d.style.opacity = 0;
          },50);
        }
      }

      await wait(1900);
      animationPiecesContainer.innerHTML = '';
      firstBackground.style.opacity = 1;
      await wait(1500);
      secondBackground.style.opacity = 1;
      await wait(1500);
      narrationText.style.opacity = 1;
      await wait(3000);
      narrationText.style.opacity = 0;
      await wait(1000);
      narrationText.style.display = 'none';
      showNextSubtitle();
    }

    function endStory(){
      subtitle.style.opacity = 0;
      countdownScreen.textContent = 'Fin';
      countdownScreen.style.display = 'block';
    }

    let currentSubtitleIndex = 0;
    let currentMode = 'komachi_en';

    function showNextSubtitle(){
      const data = (currentMode === 'komachi_en') ? subtitlesKomachi_en : subtitlesEgypt_en;

      if(currentSubtitleIndex >= data.length){
        if(currentMode === 'komachi_en'){
          currentMode = 'egypt_en';
          currentSubtitleIndex = 0;
          setTimeout(showNextSubtitle, 1000);
        }else{
          endStory();
        }
        return;
      }

      const item = data[currentSubtitleIndex];
      gameContainer.style.backgroundImage = `url('${item.image}')`;
      subtitle.textContent = item.text;
      subtitle.style.opacity = 1;

      firstBackground.style.display = 'none';
      secondBackground.style.display = 'none';

      setTimeout(()=>{
        subtitle.style.opacity = 0;
        currentSubtitleIndex++;
        setTimeout(showNextSubtitle, 1000);
      }, 4000);
    }

    // ✅ 手動開始：ボタンで開始（自動起動はしない）
    startBtn.addEventListener('click', async ()=>{
      startBtn.disabled = true; startBtn.textContent = 'Loading...';
      await preloadImages(preloadList);
      startBtn.style.display = 'none';
      setTimeout(startIntroAnimation, 300);
    });

    // （もし残っていたら）下の自動起動コードは削除 or コメントアウト
    // window.onload = () => { setTimeout(startIntroAnimation, 1000); };
  </script>
</body>
</html>
